# TypeCraft Continuity Ledger

## Goal
Build a Space Invaders-style typing game (TypeCraft) with React 19 + TypeScript + Vite. Full spec in docs/SPEC.md, plan in docs/plans/2026-01-31-typecraft.md.

## Constraints/Assumptions
- TDD approach: tests written first (RED), then implement (GREEN)
- Pure logic in src/lib/ (zero React deps), hooks in src/hooks/, components in src/components/
- Immutable state — engine functions return new state, never mutate
- TypeScript strict mode with verbatimModuleSyntax
- localStorage persistence under key "typecraft"

## Key Decisions
- 21-task plan with 4 layers (pure logic → hooks → components → integration)
- Implemented all layers in one pass since tests already existed
- stats.ts uses SessionRecord type (with timestamp+wpm) per existing tests
- Wave generator and game engine use deterministic 70/30 split (pre-allocated counts) to avoid flaky tests
- StatsScreen defaults to sorting by key (not accuracy) so clicking Accuracy header sorts ascending first
- spawnWave uses selectWordsForFocus to pick words/code-snippets, then expands to character invaders with batch positioning
- Dead invaders pruned between waves; totalSpawned counter for accurate accuracy
- Invaders colored by char type (letters=blue/green, symbols=red/orange, numbers=purple)
- Explosion system: Explosion[] state in App.tsx, passed to GameBoard, 8 CSS-animated particles per explosion, 300ms duration
- bestSpeedMs uses 0 sentinel (not Infinity) to survive JSON serialization
- OnboardingDemo uses rAF animation loop with queueMicrotask for proximity state update

## State
### Done
- All 21 plan tasks DONE
- **All 11 lib modules**: keys, scoring, game-engine, wave-generator, stats, storage, settings, adaptive-calibration, accuracy-ring, sprites, word-list
- **Both hooks**: useGameState, useGameLoop
- **All 10 components**: HUD, GameBoard, RoundSummary, MainMenu, RoundEnd, Countdown, SettingsScreen, StatsScreen, OnboardingDemo, PauseMenu
- **App.tsx fully wired**: menu → demo → calibration → playing (with pause, round-end, round-summary)
- **Dark theme CSS**: complete visual styling
- **Settings persistence**: updateSettings wired to SettingsScreen
- **Word-based batch spawning**: spawnWave uses selectWordsForFocus
- **Key profile tracking**: recordKeyResult captures hit/miss/reaction time
- **Calibration flow**: focus keys correctly set from calibration round configs
- **High score tracking**: updated on round completion, persisted
- **Invader colors**: by character type using sprites.ts color system
- **Dead invader cleanup**: pruned between waves
- **Staggered spawning**: invaders spawn in batches of ~3 every 1-2s, not all at once
- **Accuracy ring visual**: SVG circular progress ring around grape cluster, updates on hits/misses
- **Auto-timed round end**: auto-dismisses after 1.5s; 3-2-1 countdown between rounds
- **Responsive board**: viewport-based sizing via resize listener, dynamic center
- **Pause menu accuracy fix**: uses totalSpawned instead of invaders.length
- **Comprehensive state transition tests**: 17 tests covering full game flow
- **clearCalibrationData preserves highScore**: verified with test
- **Destroy animation**: pixel-scatter explosion (8 particles, CSS animation, 300ms, non-blocking)
- **handleKeyPress returns destroyedPosition**: for rendering explosions at correct location
- **Flaky wave test fix**: spawnWave trimming now prefers removing non-focus chars
- **Playtested in browser**: explosions working, full gameplay flow confirmed
- **E2E testing**: 13 Playwright tests covering all critical user flows
- **Vitest exclude e2e/**: vite.config.ts excludes e2e/ from Vitest to avoid Playwright conflicts
- **Absorb animation**: red flash + dissolve inward at collision point (400ms CSS animation)
- **Grape burst animation**: 6 juice droplet particles spray outward when grape lost (500ms CSS animation)
- **checkCollisions returns CollisionEvent[]**: position + grapeLost flag for animation triggers
- **Bug fixes (iteration 9)**: WPM with accuracy multiplier, real WPM tracking in rounds, learning speed 5-round window, wave formula 3+N (N=0), reaction time accumulation, miss doesn't record 0ms
- **Trend calculation (iteration 10)**: computeTrend() using linear regression on last 10 data points per key
- **Removed duplicate round info**: GameBoard no longer renders wave/grape info (already in HUD)
- **Per-key bests (iteration 11)**: bestAccuracy and bestSpeedMs tracked in KeyProfile, JSON-safe 0 sentinel
- **Keys improved/declined (iteration 12)**: round-start accuracy snapshot compared to round-end, passed to RoundSummary
- **Stats screen color-coding (iteration 13)**: rows tinted red-to-green based on accuracy weakness
- **Onboarding demo overhaul (iteration 14)**: spatial invaders with rAF movement, proximity-triggered "Watch out!" prompt
- **Adaptive calibration wired (iteration 15)**: CalibrationTracker now used in useGameLoop during calibration mode
- **Calibration summary enhanced (iteration 16)**: shows overall accuracy, strongest keys, and weakest keys
- **Storage wipe on parse error (iteration 17)**: corrupted localStorage now explicitly removed per spec
- **Dead code cleanup (iteration 18)**: removed unused RoundRecord and KeyGroupName types
- **Recalibrate confirmation dialog (iteration 19)**: MainMenu shows confirm/cancel before recalibrating
- **New high score display (iteration 19)**: RoundSummary shows "NEW HIGH SCORE" when applicable
- **Grape spring animation (iteration 20)**: grapes animate with spring easing when cluster reflows after loss
- **Bug fix (iteration 21)**: averageTimeMs no longer diluted by misses (timeMs=0 skipped); reaction time only tracks hits
- **Trend arrow colors (iteration 22)**: green/red/grey trend indicators in StatsScreen
- **Schema wipe notice (iteration 23)**: "Data format updated" notice shown on main menu after version mismatch wipe
- **Bug fix (iteration 24)**: practice mode completeRound no longer changes screen to 'round-summary' (which had no renderer); removed dead Screen type
- **Grape vine/stem (iteration 25)**: thin green vine line with leaf curl above grape cluster
- **Bug fix (iteration 26)**: practice mode now re-ranks focus keys after each round (was stuck on same keys)
- **Round history score (iteration 27)**: round score persisted in RoundHistoryEntry
- **Bug fix (iteration 28)**: bestSpeedMs tracks fastest individual hit, not running average
- **Bug fix (iteration 29)**: pause menu avgReactionMs computed from real data instead of hardcoded 0
- **Bug fix (iteration 30)**: recalibration preserves totalKills (correctAttempts) per key per spec
- **SpriteRenderer (iteration 31)**: pixel-art sprite grids rendered behind invader characters per spec
- **Color-blind modes (iteration 32)**: deuteranopia (blue/orange) and protanopia (blue/yellow) palettes, toggled in settings
- **Bug fix (iteration 33)**: Settings from HUD/Pause during gameplay now renders as overlay, returns to game on close (not main menu). Added settingsSource state, Escape closes settings, 4 new tests.
- **Bug fix (iteration 34)**: averageTimeMs running average used totalAttempts instead of correctAttempts as divisor, causing dilution after hit-miss-hit sequences. Also: no-hit profiles now treated as max slowness in weakness scoring.
- **Comprehensive useGameLoop test coverage (iteration 35)**: 15 new tests for the critical 157-line game loop hook — start/stop, handleKeyPress (hit/miss/nearest-targeting), game tick movement, collision events (onCollisions), round completion (grape-loss + cleared), wave auto-advance, pendingSpawns blocking advance, calibration mode recording, unmount cleanup
- **Bug fix (iteration 36)**: Modifier keys (Shift/Control/Alt), function keys (F1-F12), arrow keys, and other non-character keypresses created phantom key profiles with 100% miss rate, contaminating weakness ranking and potentially becoming focus keys with unmatchable invader labels. Also: CapsLock/Shift+letter produced uppercase that never matched lowercase invaders. Fix: filter e.key.length !== 1, normalize to lowercase. 2 new tests.
- **Bug fix (iteration 37)**: Accuracy calculation in App.tsx used totalSpawned as denominator, which includes pending invaders still in the staggered spawn queue. When round ends via grapes_lost while invaders are pending, accuracy was artificially diluted. Fix: use `totalSpawned - pendingSpawns.length` (actual appeared count) for both round-end accuracy and pause menu accuracy. WPM also corrected to use appeared count. 1 new test.
- **Bug fix (iteration 38)**: HUD recalibrate button during gameplay called recalibrate() directly without confirmation or screen transition, leaving game in broken state (data wiped, screen stuck on 'playing'). Fix: pauses game, shows confirmation overlay. Confirm → recalibrate + go to menu. Cancel/Escape → resume gameplay. 3 new tests.
- **Bug fix (iteration 39)**: Space key and other non-invader single characters (backtick, tilde, etc.) with e.key.length===1 passed the modifier key filter but are not in KEY_GROUPS. Pressing them created phantom profiles with 100% miss rate. Fix: add ALL_KEYS.includes(key) guard after lowercase normalization. 1 new test.
- **Bug fix (iteration 40)**: useGameLoop start() reset calibrationTrackerRef on every call including pause/resume, erasing adaptive speed adjustments mid-calibration. Fix: only reset tracker when currentWave === 0 (new round start). 1 new test.
- **Bug fix (iteration 41)**: maxInvadersPerWave setting was user-configurable in Settings UI and persisted to localStorage but never passed to createRoundState() — always defaulted to 12 regardless of user setting. Fix: pass settings.maxInvadersPerWave to both createRoundState call sites in App.tsx. Also: validateSettings() was defined and tested but never called in production code — corrupted localStorage settings could cause out-of-range values. Fix: call validateSettings() in loadState(). 2 new tests.
- **Spec fix (iteration 42)**: Speed preset changes during gameplay only affected newly spawned waves — existing invaders kept their old velocity. Spec says "changes apply immediately for speed". Fix: added rescaleInvaderSpeeds() to game-engine.ts that rescales alive invaders' velocity magnitude and pending spawns' speed to the new effective speed (base + wave escalation). Wired into useGameLoop tick function with prevSpeedRef change detection. 4 new tests.
- **Responsive OnboardingDemo (iteration 43)**: OnboardingDemo hardcoded 800x600 viewport, CENTER_X=400, CENTER_Y=300, and fixed spawn positions. Spec says game fills viewport. Fix: accept boardSize prop, compute center and spawn positions as fractions of actual dimensions. App.tsx now passes viewportSize to OnboardingDemo.
- **Defensive fix (iteration 44)**: selectWordsForFocus crashed with empty focusKeys — Math.floor(Math.random() * 0) = NaN, producing undefined array values. Fix: early return with fallback character 'a' when focusKeys empty. 1 new test.
- **E2E regression tests (iteration 45)**: Added 4 E2E tests covering recent bug fixes: HUD recalibrate during gameplay shows confirmation overlay (cancel returns to game), HUD recalibrate confirm goes to menu, HUD settings overlay returns to gameplay on close. Prevents regressions on iterations 33 and 38 fixes.
- **OnboardingDemo hook stability + a11y (iteration 46)**: Fixed stale closure bugs — spawnPositions now computed with useMemo, center coordinates read from ref in rAF tick and keydown handler. Added aria-label to GameBoard for screen readers.
- **Bug fix (iteration 47)**: recordKeyResult in useGameState.ts read appState from closure — rapid keypresses within one React frame silently lost key profile data (only last survived). Fix: functional setAppState updater ensures each call sees latest state. Also: WORDS array had 'True', 'False', 'None' with uppercase, creating unhittable ghost invaders since keypress handler lowercases input. Fix: lowercased to 'true', 'false', 'none'. 2 new tests.
- **Bug fix (iteration 48)**: Phantom keypress after round end — React batches setRoundEndResult, so keydown handler fires before guard sees roundEndResult !== null. Keypresses after round end recorded false misses to key profiles, corrupting weakness ranking. Fix: synchronous stateRef.current.roundOver check in useGameLoop handleKey. 1 new test.
- **Spec fix (iteration 49)**: Practice rounds were 100% focus keys (non-focus chars aggressively trimmed from words). Spec requires 70% focus / 30% filler for variety. Fix: spawnWave now generates focusCount=70% from word-derived focus chars and fillerCount=30% from ALL_KEYS minus focusKeys. Also removed dead generateWaveChars function. 1 new test, 3 dead tests removed.
- **Bug fix (iteration 50)**: Explosion effects always used default color palette, ignoring color-blind mode setting. Fix: pass settings.colorBlindMode to getCharColor when creating explosions.
- **Spec fix (iteration 51)**: Filler keys used random ALL_KEYS minus focusKeys instead of spec-required "next-weakest keys (ranked 6-10)". Fix: wired getNextPracticeRound's fillerKeys through AppState.currentFillerKeys → useGameState callbacks (startGame, completeRound, beginPractice) → App.tsx createRoundState → spawnWave. 1 new test.
- **Bug fix (iteration 52)**: Calibration rounds frozen from initial mount — recalibrate() only reset the index but reused the same randomized order. Spec says "order randomized each time calibration is triggered". Fix: setCalibrationRounds(getCalibrationRounds()) in recalibrate(). 1 new test.
- **Bug fix (iteration 53)**: Practice-mode filler keys (ranked 6-10) leaked into calibration rounds after recalibrate. clearCalibrationData didn't clear currentFillerKeys, and calibration paths in useGameState didn't explicitly set currentFillerKeys:[]. Fix: clear fillerKeys in clearCalibrationData, startGame calibration branch, completeDemo, and completeRound calibration branch. 1 new test.
- **Defensive fix (iteration 54)**: KeyProfile.history[] grew unbounded — every keypress appended with no cap. computeTrend only uses last 10 points. Over long sessions this bloats localStorage. Fix: cap history at 20 entries via .slice(-20) in recordKeyPress. 1 new test.
- **Code quality (iteration 55)**: Fixed ESLint warning — settings.colorBlindMode missing from keydown useEffect dependency array (explosions could use stale color palette). Removed duplicate DEFAULT_SETTINGS from useGameState.ts, now imports from settings.ts (DRY).
- **UX fix (iteration 56)**: RoundSummary showed raw numbers without descriptive labels. Added "Grapes:", "Accuracy:", "Avg Reaction:", "Improved:", "Declined:" labels per spec.
- **Spec fix (iteration 57)**: Calibration rounds got 30% random filler despite spec only describing 70/30 under Practice Mode. Root cause: App.tsx converted empty fillerKeys[] to undefined, causing spawnWave to fall back to ALL_KEYS. Fix: pass fillerKeys directly; spawnWave uses 100% focus when fillerKeys is explicitly []. 1 new test.
- **UX fix (iteration 58)**: HUD showed just "Calibration" during calibration rounds — player couldn't tell which key group was being tested. Spec layout shows "Round 3: Python Symbols". Fix: added KEY_GROUP_DISPLAY_NAMES mapping to keys.ts, exposed calibrationRoundName from useGameState, App.tsx now shows "Calibration: Home Row" etc. 2 new tests.
- **Bug fix (iteration 59)**: Round summary showed overall weakest keys as "next focus" during calibration, but should show the next calibration group's keys. Fix: exposed nextCalibrationKeys from useGameState (next group in calibration sequence), App.tsx uses it when available. 2 new tests.
- **Bug fix (iteration 60)**: Browser refresh mid-calibration lost progress — calibrationRoundIndex reset to 0 and calibrationRounds got re-randomized, causing repeated/skipped groups. Fix: persist calibration order in AppState.calibrationOrder, restore index from completedGroups.length, reconstruct rounds from persisted order on load. 1 new test.
- **Defensive fix (iteration 61)**: After 5th calibration round, countdown timer ran invisibly and called startNewRound() pointlessly. Fix: cancel countdown when screen transitions away from 'playing'.
- **Bug fix (iteration 62)**: Two fixes: (1) Tab switch caused invader teleportation — rAF timestamp jumps ahead while tab hidden, producing huge deltaSeconds. Fix: cap deltaSeconds at 0.1s in useGameLoop tick. (2) Escape key during round-end/countdown/summary screens toggled pause unexpectedly. Fix: guard clause ignores Escape during those transitions. 1 new test.
- **UX fix (iteration 63)**: HUD bottom bar showed "4/8" and "20/24" without labels. Spec layout requires "Wave 4/8" and "Grapes: 20/24". Also: currentWave starts at 0, briefly showing "Wave 0/8". Fix: added labels, clamped wave display to min 1. 1 new test.
- **Spec fix (iteration 64)**: Invader character font was 22px but spec requires "monospace, 28px+". Increased to 28px, invader container from 40px→48px, sprite from 36px→44px for visual balance. Also updated E2E grape-count assertion to match new "Grapes: 24/24" label.
- **Visual fix (iteration 65)**: Grape 3D sphere missing white specular highlight per spec. Spec says "with a white specular highlight". Fix: added rgba(255,255,255,0.6) highlight at 30% 30% position in radial gradient.
- **Code quality (iteration 66)**: Learning speed display condition simplified from dual check to `roundHistory.length < 10`. Spec says "Requires 10+ rounds to display" — condition now matches spec wording directly.
- **Spec fix (iteration 67)**: Grape cluster had fixed density — when grapes were lost, cluster just shrank. Spec requires "Fixed zone, variable density: fewer grapes spread out, more pack tighter." Fix: dynamic gap computed from maxGrapes/grapes ratio, capped at 14px. 1 new test.
- **Spec fix (iteration 68)**: Stats screen Trend column wasn't sortable — spec says "Sortable by any column". Added 'trend' to SortColumn type, numeric mapping (improving=1, stable=0, declining=-1), onClick handler. 1 new test.
- **Spec fix (iteration 69)**: Explosion flash used only character color. Spec says "Destroyed invader: bright flash (white/yellow)". Fix: pixel-scatter animation starts with bright #ffffaa flash at scale 1.3, transitions to character color by 20%. Uses --particle-color CSS variable.
- **Spec fix (iteration 70)**: Round End screen had no animations. Spec says "GAME OVER with dramatic animation (cluster shatters)" and "ROUND CLEAR celebration screen". Fix: GAME OVER gets red text with shake + 12 grape-colored shatter particles scattering from center. ROUND CLEAR gets green text with scale-up glow pulse. 2 new tests.
- **Spec fix (iteration 71)**: HUD weak keys section missing "Weak:" label prefix — spec layout diagram shows `Weak: [ _ ] [ { ] ...`. Also: MainMenu "Stats" button text should be "Stats/Leaderboard" per spec. 1 new test.
- **Bug fix (iteration 72)**: Invaders near the center got z-index values up to 600+ (based on viewport diagonal), exceeding overlay z-indexes (pause: 300, round-end: 200). This caused invaders to render ON TOP of pause menu/round-end/settings overlays. Fix: cap invader z-index at 99 with Math.min(99, ...). Confirmed visually in browser. 1 new test.
- **Bug fix (iteration 73)**: Double keypress processing — GameBoard had its own onKeyDown handler AND App.tsx registered a global window keydown listener. When the game board had focus, a single keypress fired both handlers, silently destroying TWO invaders (second kill had no explosion, no stats recording, no accuracy ring update). Fix: removed onKeyDown from GameBoard div, removed dead onKeyPress prop from GameBoardProps interface and all call sites. 1 new test.
- **E2E fix (iteration 74)**: Recalibrate E2E test broken since iteration 19 — test didn't click Confirm in the confirmation dialog added that iteration. Fixed by adding the missing confirm click.
- **Spec fix (iteration 75)**: Session-level stats (totalRounds, totalPlayTimeMs) not persisted per spec's "Stored Data" requirement. Added fields to AppState, incremented in completeRound, wired roundDurationMs from App.tsx. 3 new tests.
- **UX fix (iteration 76)**: Session-level stats (totalRounds, totalPlayTimeMs) stored but never displayed. Added lifetime stats section to StatsScreen showing "N rounds" and formatted play time (Xh Ym). Exposed fields from useGameState, wired through App.tsx. 1 new test.
- **Spec fix (iteration 77)**: Sprite templates assigned deterministically (modulo cycling) instead of randomly per spec. Added `spriteIndex` field to Invader, assigned randomly in createInvader(). GameBoard now reads inv.spriteIndex. Removed dead `assignSprite`/`AssignedSprite` from sprites.ts. 1 new test, 2 dead tests removed.
- **Spec fix (iteration 78)**: Grape burst missing "squash" animation per spec "sphere squashes, splits into juice droplets". Added squashing grape element rendered in cluster during grape bursts, with CSS animation (scaleX grows while scaleY shrinks, then fades). 1 new test.
- **Bug fix (iteration 79)**: OnboardingDemo double-spawned the first invader (two 'a' elements with same test ID), failing 2 Playwright E2E tests with strict mode violation. Root cause: useEffect re-fired when spawnPositions ref changed (viewport resize) while nextSpawnIndex was still 0. Fix: added spawnedCountRef guard to prevent spawning same index twice. Also improved React key from index to inv.char for stability.
- **UX fix (iteration 80)**: Stats screen showed misleading "0ms" for Avg Speed and Best Speed columns when a key had 0 kills. Changed to show "—" (em dash) for zero-kill keys, consistent with HUD's use of "—" for unavailable data. 1 new test.
- **Spec fix (iteration 81)**: RoundSummary labels didn't match spec exactly. Changed "Grapes:" → "Grapes survived:", "Avg Reaction:" → "Average reaction time:", "Improved:" → "Keys improved:", "Declined:" → "Keys declined:", "Next:" → "Next round:".
- **Spec fix (iteration 82)**: Collision radius was 30px but grape cluster visual boundary is 60px (120px CSS width / 2). Spec says "cluster's visual bounding radius + small margin." Invaders were passing through outer grapes before being absorbed. Extracted CLUSTER_COLLISION_RADIUS = 60 constant in game-engine.ts, used in useGameLoop.ts. 2 new tests.
- **Perf fix (iteration 83)**: useGameLoop returned a new object on every render, causing the keydown effect in App.tsx to constantly remove/re-add the window listener. Memoized the return value with useMemo so it only changes when running/start/stop/handleKey actually change.
- **Dead code cleanup (iteration 84)**: RoundSummary had 2 unused props (highScore, focusKeys) in its interface, passed from App.tsx but never read. Removed from interface, App.tsx call site, and test fixture.
- **Plan checklist**: Marked all 27 visual verification items as complete in docs/plans.
- **Test coverage (iteration 85)**: SettingsScreen had zero tests for color-blind mode buttons despite being fully implemented. Added 4 unit tests: default "Off" display, Deuteranopia button calls onUpdate, Protanopia button calls onUpdate, aria-pressed state reflects active mode. src/__tests__/SettingsScreen.test.tsx (6→10 tests).
- **Bug fix (iteration 86)**: Quit mid-round didn't discard key profile changes — spec says "discards all round data" but recordKeyResult persisted profiles immediately on every keypress. Fix: snapshot keyProfiles at round start (in startGame/completeDemo/beginPractice/completeRound), restore from snapshot in new quitRound() function. App.tsx quit handler now calls quitRound() instead of goToMenu(). Hardened with functional updater to avoid stale closure. 2 new tests.
- **Defensive fix (iteration 87)**: roundHistory grew unbounded — no cap on array length. Over long play sessions (500+ rounds), this could bloat localStorage. Learning speed only uses last 10. Fix: `.slice(-200)` in completeRound keeps most recent 200 entries. 1 new test.
- **Visual polish (iteration 88)**: 3 CSS classes used in JSX had no definitions — .confirm-dialog (MainMenu recalibrate), .new-high-score (RoundSummary), .demo-ready-btn (OnboardingDemo). Added styled definitions: confirm-dialog gets red-tinted card, new-high-score gets gold text with pulse animation, demo-ready-btn gets styled button matching theme.
- **UX fix (iteration 89)**: Onboarding demo showed "Ready? Let's calibrate!" twice — once as prompt text and once as button. Spec only mentions the button. Fix: hide prompt paragraph when allDone is true, removed dead prompt assignment.
- **Code quality (iteration 90)**: Removed unnecessary `as Settings` type cast in App.tsx. Made AppState.settings use the `Settings` type directly instead of inline type with wider `string` fields. Removed unused `Settings` import from App.tsx.
- **Test coverage (iteration 91)**: Added backward compatibility test for old localStorage data missing `colorBlindMode` field. Verifies `validateSettings` defaults it to `'none'`.
- **Bug fix (iteration 92)**: `recordKeyPress` produced NaN when processing old profiles missing `lifetimeKills`, `bestAccuracy`, or `bestSpeedMs` fields (added in later iterations). These fields would be `undefined` after JSON.parse of old localStorage data. Fix: nullish coalescing (`?? 0`) on all three fields. 1 new test.
- **E2E test (iteration 93)**: Added E2E test for color-blind mode persistence across page reload. Also fixed pre-existing E2E failure: OnboardingDemo's grape target div intercepted pointer events on the calibrate button (added `pointerEvents: 'none'` to the decorative grape target).
- **Bug fix (iteration 94)**: "Data format updated" notice not shown when localStorage contained corrupted JSON. Spec says notice must appear for both schema version mismatch AND JSON parse errors. Fix: set `dataWiped = true` in the catch block of loadState(). 1 new test.
- **Accessibility + test coverage (iteration 95)**: Countdown component had zero unit tests and no accessibility attributes. Added `role="status"` and `aria-live="assertive"` for screen reader announcements. Created 3 unit tests covering rendering, a11y attributes, and aria-label updates.
- **Defensive fix (iteration 96)**: useViewportSize resize handler lacked the 800x600 fallback that initial state had. If window.innerWidth/innerHeight became 0 (minimized window, etc.), board dimensions would be 0, causing NaN invader positions and unplayable game state.
- **Test coverage (iteration 97)**: Added 2 tests for wave-generator's filler key selection (ranks 6-10 for 70/30 focus/filler) and empty filler when <6 profiles. Also verified full spec compliance — all required features implemented.
- **A11y cleanup (iteration 98)**: StatsScreen table headers: replaced redundant `role="columnheader"` with semantic `scope="col"` (HTML5 `<th>` already implies the columnheader role). Cleaner markup, same accessibility.
- **E2E test (iteration 99)**: Added practice round completion E2E test — the core gameplay loop (start → destroy all invaders → round-end → round-summary → "Next Round" button). First E2E coverage of practice mode completion.
- **Defensive fix (iteration 100)**: `loadState()` condition `data.schemaVersion !== undefined && data.schemaVersion !== SCHEMA_VERSION` allowed JSON without a schemaVersion field to pass through without validation. Externally-written or tampered localStorage data missing required fields (roundHistory, calibrationProgress) would load and crash the app when accessing .map() on undefined. Fix: simplified condition to `data.schemaVersion !== SCHEMA_VERSION`. 2 new tests.
- **Perf fix (iteration 101)**: `useGameState` called `loadState()` 4 times during initialization — each `useState` initializer independently parsed localStorage JSON. Fix: single `loadState()` call cached in an `initData` useState, all derived values computed from that one result.
- **Perf + stability fix (iteration 102)**: GameBoard used `roundState.invaders.indexOf(inv)` for React keys — O(N²) per render and unstable (indices recycle when dead invaders pruned between waves). Added unique `id: number` field to `Invader` interface with module-level auto-incrementing counter. GameBoard now uses `inv.id` for both `key` and `data-testid`. 1 new test.
- **Defensive fix (iteration 103)**: Adaptive calibration speed had no bounds — repeated 10% increases/decreases could push speed to 2.6x or 0.35x base, making the game unplayable. Fix: clamp speed to [0.5x, 2x] base speed. 2 new tests.
- **Bug fix (iteration 104)**: `bestAccuracy` in StatsScreen was always 100% for every key with at least one hit, because it was computed from `correctAttempts/totalAttempts` which is 1/1=100% after the first hit. Made the "Best Acc" column useless. Fix: only start tracking bestAccuracy after 10+ attempts so the accuracy ratio is statistically meaningful. 1 new test.
- **UX + code quality (iteration 105)**: StatsScreen showed empty table (headers with no rows) when no key data exists. Added "No data yet" empty state message. Also: removed unnecessary `as keyof typeof SPEED_PRESETS` cast and redundant `?? 'normal'` in App.tsx baseSpeed calculation. 1 new test.
- **UX fix (iteration 106)**: StatsScreen "Best Acc" column showed "0%" for keys with < 10 attempts (bestAccuracy = 0 from iteration 104 fix). Misleading since 0% implies no accuracy when really there's just not enough data. Changed to show "—" (dash) when bestAccuracy = 0, consistent with avgSpeedMs/bestSpeedMs display. 1 new test.
- **E2E test (iteration 107)**: Added E2E test for calibration gameplay → summary → practice transition. Tests the critical first-user calibration path: resume from 4/5 groups done, play through last calibration round (actual keyboard gameplay destroying invaders), see round-end and round-summary, click "Next Round" → calibration summary with stats, click "Begin Practice" → practice gameplay starts. First E2E coverage of calibration mode gameplay and calibration-summary screen.
- **Defensive fix (iteration 108)**: `spawnWave` produced invaders with `char: undefined` when `focusKeys` was empty (e.g., corrupted localStorage). The padding loop `state.focusKeys[Math.floor(Math.random() * 0)]` = `undefined`. Fix: added fallback to home row keys `['a','s','d','f','g','h','j','k','l']` when focusKeys is empty. Also updated all `state.focusKeys` references in spawnWave to use the guarded local variable. 1 new test.
- **Spec fix (iteration 109)**: HUD learning speed showed just `+3` but spec layout diagram shows `+3/5rnd`. Added `/5rnd` suffix to both positive and negative learning speed display. 1 new test.
- **Spec fix (iteration 110)**: Pause menu stats section had no heading label. Spec lists "Current Round Stats" as a labeled section. Added `<h3>Current Round Stats</h3>` heading above the accuracy/kills/reaction stats. Updated test to verify heading.
- **Spec fix (iteration 111)**: Recalibration wiped personal bests (bestAccuracy, bestSpeedMs) despite spec saying "Keeps: ... lifetime achievements preserved." These are lifetime achievements like lifetimeKills/highScore. Fix: preserve them in clearCalibrationData. Updated test expectations.
- **Spec fix (iteration 112)**: StatsScreen column headers didn't match spec table names. "Accuracy" → "Accuracy %", "Avg Speed" → "Avg Speed (ms)", "Kills" → "Total Kills", "Best Acc" → "Best Accuracy". Updated test selector to avoid ambiguous match.
- **E2E test (iteration 113)**: Stats screen content verification — seeds localStorage with key profiles (accuracy, kills, speed) and session stats, navigates to stats screen, verifies per-key rows render with correct accuracy/kills data, and session-level stats display. First E2E coverage of actual stats data rendering.
- **Bug fix (iteration 114)**: OnboardingDemo keydown handler didn't lowercase `e.key`, so CapsLock/Shift caused uppercase characters that never matched lowercase invader chars. Main game handler (App.tsx) already did `.toLowerCase()` but demo handler didn't. Fix: added `e.key.length !== 1` guard and `e.key.toLowerCase()` normalization. 1 new test.
- **Bug fix (iteration 115)**: RoundSummary labeled keys with unchanged accuracy as "declined". `keysDeclined` was derived as `keysDefined - keysImproved`, which included stable keys. Fix: compute `keysDeclined` explicitly in App.tsx (only keys where `currentAcc < snapshot[k]`), pass directly to RoundSummary. Removed `keysDefined` prop. 1 new test.
- **Visual fix (iteration 116)**: Pause menu "Current Round Stats" heading was inline with stat values due to `.pause-stats` horizontal flex layout. Fix: changed to column direction with heading above, stats in a nested `.pause-stats-row` horizontal flex container.
- **Code quality (iteration 117)**: Fixed orphaned JSDoc comment in e2e/game-flow.spec.ts — description for "HUD settings returns to gameplay" test was separated from its test when "practice round completion" test was inserted between them.
- **Accessibility (iteration 118)**: Added `aria-label` to all three range inputs in SettingsScreen (grapeCount, maxInvadersPerWave, wavesPerRound) for screen reader accessibility. Added `button:focus-visible` CSS outline for keyboard navigation. 1 new test.
- **Stale closure fix (iteration 119)**: `updateSettings` in useGameState.ts used `appState` from closure instead of functional updater. If React batched a `recordKeyResult` call with `updateSettings` in the same frame, key profile data would be lost (same class of bug fixed in iteration 47 for `recordKeyResult`). Fixed with `setAppState((prev) => ...)` functional updater. 1 new test.
- **Visual fixes (iteration 120)**: Four user-reported issues: (1) Invader character labels unreadable — text color inherited sprite's primaryColor, making same-color text on same-color sprite invisible. Fix: forced white text with 4-directional dark outline shadows in CSS. (2) Grapes didn't look like grapes — flat purple circles. Fix: improved 3D gradient with brighter specular highlight, inset shadows for depth, slightly oval shape (16x18px). (3) Grape cluster too dense, not clearly countable. (4) Grape cluster should look like a real grape bunch with stems. Fix: replaced flex-wrap grid with row-based triangular bunch layout — `computeBunchRows()` creates a tapered shape (wider at top, narrowing down). Added central brown trunk line (`grape-trunk`), small stems on each grape (`::before` pseudo-element), and `.grape-row` flex containers. Layout computed from `maxGrapes` so shape stays fixed as grapes are lost (grapes disappear from bottom). Accuracy ring auto-sized to cluster width. Updated variable-density test. Also: removed debug console.log, deferred first-wave spawn from start() to tick, useLayoutEffect for stateRef syncing.
- **Race condition fix (iteration 121)**: Calibration first round showed wrong invader characters (home row 'a','s','d','f' instead of actual calibration group's keys). Root cause: `setRoundState()` and `gameLoop.start()` fired in same render's effects — rAF tick read stale stateRef before React flushed. Fix: added `resetState()` method to useGameLoop that writes directly to stateRef, bypassing React's async batching. Wired via `gameLoopResetRef` in App.tsx so `startNewRound()` syncs state immediately. 1 new test.
- **Lint/code quality fixes (iteration 121)**: (1) Moved `gameLoopResetRef.current` assignment from render phase into useEffect — fixes React "cannot update ref during render" error. (2) Refactored GameBoard grape rendering to precompute visible-per-row array instead of mutating `grapesLeft` during render — fixes React immutability rule violation. (3) Removed unnecessary `center` dependency from useGameLoop `start()` callback. (4) Removed unused `GAP_Y` variable in GameBoard. All lint errors and warnings resolved.
- **Defensive fix (iteration 122)**: `getNextPracticeRound({})` with empty profiles returned empty `focusKeys: []`, relying on downstream fallbacks in App.tsx and spawnWave. Could cause degraded first-practice experience if profiles corrupted. Fix: early return with home row defaults `['a','s','d','f','g']` when profiles is empty. 1 new test.
- **README overhaul**: Replaced Vite boilerplate with project-specific README: game overview with screenshots (main menu, gameplay, stats), quick start, architecture overview (3-layer diagram: lib/hooks/components), state management diagram (useGameState vs useGameLoop), testing section, tech stack.
- **293 unit tests, 20 E2E tests (all pass), build clean, lint clean**
- **Word list expansion (iteration 123)**: WORDS array expanded from 542 to 600 entries (spec target ~600). Added 58 common English words for better gameplay variety.
- **UX fix (iteration 124)**: Onboarding demo prompt text ("Type the character to destroy the invader!") overlapped with grape target at center — text was unreadable behind the grape. Moved prompt to bottom 12% of screen via absolute positioning.
- **Bug fix (iteration 125)**: HUD displayed stale between-rounds WPM average during gameplay instead of live round WPM. Added liveWpm state computed per-tick from appeared count, accuracy, and elapsed time. Passed to HUD instead of gameState.currentWPM. 1 new test.
- **Spec fix (iteration 126)**: selectWordsForFocus used all-or-nothing pool selection — WORDS for any alphanumeric focus key, CODE_SNIPPETS only when ALL keys are symbols. Mixed letter+symbol keys (e.g., ['z', ';', ',']) searched only WORDS, which contains no symbols, so symbol focus keys never appeared in word-derived batches. Fix: always search both WORDS and CODE_SNIPPETS pools, combine matches. Added 3 CODE_SNIPPETS ('a/b', 'x;y', 'a;b') for '/' and ';' coverage. 1 new test.
- **Perf fix (iteration 127)**: Invader movement jank — user reported "obvious pause point". Root cause: invader positioning used `left`/`top` CSS properties, triggering expensive layout recalculation (reflow) every frame. Also: SpriteRenderer (64 grid cells per invader) re-rendered every frame despite unchanging props. Fix: (1) switched to `transform: translate()` for GPU-accelerated compositing, (2) added `will-change: transform` CSS hint, (3) memoized SpriteRenderer with `React.memo` to skip 640+ element re-creations per second.
- **Visual fix (iteration 128)**: Grape cluster redesign per user feedback. Old: flat circle grid with thin vine line. New: (1) inline SVG `GrapeLeaf` component with 5-lobed leaf, curved stem, veins, and radial gradient highlight, (2) `computeBunchRows` redesigned for natural triangular taper (wider at top, narrowing down), (3) grapes enlarged (18x20px), tighter row overlap (gap: 2px, negative margin), enhanced 3D gradient with brighter specular and shadow layers, (4) removed dead `.grape-vine`/`.grape-vine::after` CSS. Updated test for grape-leaf class.
- **UX fix (iteration 129)**: OnboardingDemo visual consistency — user reported demo looks very different from real game. Fixes: (1) replaced inline-styled circle with mini grape cluster using real CSS classes (grape-cluster, grape-row, grape) plus GrapeLeaf SVG, (2) demo invaders now use SpriteRenderer with pixel-art sprites and colored by character type (matching real game), (3) "Ready? Let's calibrate!" button repositioned to bottom 15% of screen via absolute positioning (was centered, overlapping the grape target).

- **Amplitude analytics (iteration 130)**: Added `@amplitude/analytics-browser` for product analytics. Pure wrapper module `src/lib/analytics.ts` (initAnalytics, trackEvent, setUserProperty) — silent no-ops when `VITE_AMPLITUDE_API_KEY` env var is missing. 12 events tracked: screen_viewed, game_started, demo_completed, calibration_completed, practice_started, round_ended, round_completed, round_abandoned, round_quit, settings_changed, recalibration_triggered, plus auto session_start/end. Events wired at state transition boundaries in App.tsx and useGameState.ts. 7 unit tests. `.env.example` committed, `.env` gitignored.

### Now
- Game is feature-complete per spec, all major bugs fixed, thoroughly tested
- Analytics integrated for funnel/engagement tracking
- 302 unit tests across 25 test files, 20 E2E tests — all passing
- Build clean, lint clean, TypeScript strict mode passing

### Next
- Continue hunting for bugs, edge cases, and improvements

## Open Questions
- None

## Working Set
- docs/plans/2026-01-31-typecraft.md — completion tracker
